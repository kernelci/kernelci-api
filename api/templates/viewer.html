<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro API Viewer</title>
    <style>
        /* ====================================================================
           BASE STYLES
           ==================================================================== */
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
            line-height: 20px;
            color: #333333;
            background-color: #ffffff;
            padding: 10px;
            margin: 0;
        }

        /* ====================================================================
           NAVIGATION MENU
           ==================================================================== */
        #menu {
            background-color: #f5f5f5;
            border-bottom: 1px solid #e5e5e5;
            border-top: 1px solid #e5e5e5;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        #menu a {
            color: #999999;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            text-decoration: none;
            padding: 10px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            display: inline-block;
        }

        #menu a:hover,
        #menu a:active,
        #menu a:focus {
            color: #333333;
            text-decoration: none;
        }

        /* ====================================================================
           REQUEST INFO SECTION
           ==================================================================== */
        #requestinfo {
            background-color: #f5f5f5;
            border-bottom: 1px solid #e5e5e5;
            border-top: 1px solid #e5e5e5;
            margin-bottom: 20px;
            padding: 10px;
        }

        #requestinfo input,
        #requestinfo button {
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            text-decoration: none;
            padding: 8px 12px;
        }

        /* ====================================================================
           MISC BUTTONS SECTION
           ==================================================================== */
        #miscbuttons {
            background-color: #f5f5f5;
            border-bottom: 1px solid #e5e5e5;
            border-top: 1px solid #e5e5e5;
            margin-bottom: 20px;
            padding: 10px;
        }

        #miscbuttons button,
        #miscbuttons select {
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            text-decoration: none;
            padding: 8px 12px;
        }

        /* ====================================================================
           NODE SEARCH TABLE
           ==================================================================== */
        .nodesearch {
            border-collapse: collapse;
            border-spacing: 1px;
            width: 100%;
            border: 1px solid #ddd;
        }

        .nodesearch th,
        .nodesearch td {
            text-align: left;
            padding: 8px;
        }

        .nodesearch tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .nodesearch tr:hover {
            background-color: #ddd;
        }

        /* Row color coding based on test results */
        .nodesearch tr.fail {
            background-color: #ffcccc;
        }

        .nodesearch tr.null {
            background-color: #ffffcc;
        }

        .nodesearch tr.jobfilter {
            border: 1px dashed red;
        }

        .nodesearch th {
            background-color: #4CAF50;
            color: white;
        }

        /* ====================================================================
           NODE INFO DISPLAY
           ==================================================================== */
        #nodeinfo {
            line-height: 20px;
            white-space: pre-wrap;
        }

        /* ====================================================================
           MODAL DIALOG
           ==================================================================== */
        #modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 4px;
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }

        /* ====================================================================
           ERROR MESSAGE
           ==================================================================== */
        .error-message {
            background-color: #ffcccc;
            border: 1px solid #ff0000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            color: #cc0000;
        }
    </style>

    <script>
        'use strict';

        /* ====================================================================
           VIEWER APPLICATION - MAIN MODULE

           This module encapsulates all functionality for the Maestro API Viewer.
           It provides a web interface for browsing and searching KernelCI nodes.
           ==================================================================== */

        /**
         * Main application namespace to avoid polluting global scope
         */
        const ViewerApp = (() => {
            // ================================================================
            // CONFIGURATION
            // ================================================================

            /**
             * Application configuration object
             */
            const CONFIG = {
                // Default search result limit
                SEARCH_LIMIT: 250,

                // Date ranges for quick searches
                WEEK_AGO_DAYS: 7,
                DAY_AGO_DAYS: 1,

                // LAVA instance URL mappings
                LAVA_URLS: {
                    'lava-baylibre': 'lava.baylibre.com',
                    'lava-broonie': 'lava.sirena.org.uk',
                    'lava-cip': 'lava.ciplatform.org',
                    'lava-collabora': 'lava.collabora.dev',
                    'lava-collabora-early-access': 'staging.lava.collabora.dev',
                    'lava-collabora-staging': 'staging.lava.collabora.dev',
                    'lava-qualcomm': 'lava.infra.foundries.io',
                },

                // Search operators mapping
                OPERATORS: {
                    '>': '__gt=',
                    '<': '__lt=',
                    '>=': '__gte=',
                    '<=': '__lte=',
                    '!=': '__ne=',
                    '=': '=',
                },

                // Table columns for search results
                TABLE_COLUMNS: ['id', 'kind', 'name', 'platform', 'state', 'result', 'created'],
            };

            // ================================================================
            // STATE MANAGEMENT
            // ================================================================

            /**
             * Application state
             */
            const state = {
                pageBaseUrl: '',
                apiUrl: '',
                weekAgoString: '',
                dayAgoString: '',
            };

            /**
             * Main menu configuration
             */
            let mainMenu = [];

            // ================================================================
            // INITIALIZATION
            // ================================================================

            /**
             * Initialize the application
             * Sets up URLs, date ranges, and renders the initial UI
             */
            function init() {
                try {
                    // Initialize URLs
                    const url = window.location.href;
                    state.pageBaseUrl = url.split('?')[0];
                    state.apiUrl = state.pageBaseUrl.replace('/viewer', '');

                    // Calculate date ranges for quick searches
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - CONFIG.WEEK_AGO_DAYS);
                    state.weekAgoString = weekAgo.toISOString().split('.')[0];

                    const dayAgo = new Date();
                    dayAgo.setDate(dayAgo.getDate() - CONFIG.DAY_AGO_DAYS);
                    state.dayAgoString = dayAgo.toISOString().split('.')[0];

                    // Configure main menu
                    mainMenu = [
                        {
                            name: 'Home',
                            suffix: '',
                        },
                        {
                            name: 'Node',
                            suffix: '?node_id=',
                        },
                        {
                            name: 'Search',
                            suffix: '?search=',
                        },
                        {
                            name: 'Last week Checkouts',
                            suffix: `?search=kind%3Dcheckout&search=created%3E${state.weekAgoString}`,
                        },
                        {
                            name: 'Last 24h Checkouts',
                            suffix: `?search=kind%3Dcheckout&search=created%3E${state.dayAgoString}`,
                        },
                    ];

                    // Render the menu
                    displayMenu();

                    // Parse URL parameters if present
                    if (url.indexOf('?') !== -1) {
                        parseParameters(url);
                    }
                } catch (error) {
                    handleError('Failed to initialize application', error);
                }
            }

            // ================================================================
            // UI RENDERING
            // ================================================================

            /**
             * Display the main navigation menu
             */
            function displayMenu() {
                const menu = document.getElementById('menu');
                const menuHtml = mainMenu.map(item =>
                    `<a class="menulink" href="${item.suffix}">${item.name}</a>`
                ).join(' ');

                menu.innerHTML = menuHtml;

                // Attach event listeners to menu links
                const links = document.getElementsByClassName('menulink');
                Array.from(links).forEach(link => {
                    link.addEventListener('click', handleMenuClick);
                });
            }

            /**
             * Clear all content divs
             */
            function clearDivs() {
                const divIds = ['nodeinfo', 'requestinfo', 'miscbuttons', 'nodesearchdiv'];
                divIds.forEach(id => {
                    const div = document.getElementById(id);
                    div.innerHTML = '';
                    div.style.display = 'none';
                });
            }

            /**
             * Display error message to user
             * @param {string} message - User-friendly error message
             * @param {Error} error - Error object for console logging
             */
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                document.body.insertBefore(errorDiv, document.getElementById('menu').nextSibling);

                // Auto-remove after 5 seconds
                setTimeout(() => errorDiv.remove(), 5000);
            }

            /**
             * Show modal dialog with message
             * @param {string} message - Message to display
             */
            function showModal(message) {
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modalcontent');
                modalContent.textContent = message;
                modal.style.display = 'block';

                // Setup close handlers
                const closeBtn = document.getElementsByClassName('close')[0];
                closeBtn.onclick = () => modal.style.display = 'none';

                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                };
            }

            /**
             * Hide modal dialog
             */
            function hideModal() {
                const modal = document.getElementById('modal');
                modal.style.display = 'none';
            }

            // ================================================================
            // NODE DISPLAY
            // ================================================================

            /**
             * Display detailed information for a single node
             * @param {string} nodeId - The node ID to display
             */
            async function displayNode(nodeId) {
                try {
                    // Hide request info section
                    const requestInfo = document.getElementById('requestinfo');
                    requestInfo.innerHTML = '';
                    requestInfo.style.display = 'none';

                    // Fetch node data from API
                    const url = `${state.apiUrl}/latest/node/${nodeId}`;
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const rawText = JSON.stringify(data);

                    // Display action buttons
                    addMiscButtons(data, rawText);

                    // Display formatted JSON
                    const nodeInfo = document.getElementById('nodeinfo');
                    nodeInfo.style.display = 'block';
                    nodeInfo.innerHTML = `<pre>${formatJson(rawText)}</pre>`;

                } catch (error) {
                    handleError(`Failed to load node ${nodeId}`, error);
                }
            }

            /**
             * Add action buttons for a node (Parent, Children, Download, LAVA Job)
             * @param {Object} data - Node data object
             * @param {string} raw - Raw JSON string
             */
            function addMiscButtons(data, raw) {
                const miscButtons = document.getElementById('miscbuttons');
                miscButtons.style.display = 'block';

                const buttons = [];

                // Parent button
                if (data.parent) {
                    buttons.push(`<button class="misc" data-href="?node_id=${data.parent}">Parent</button>`);
                }

                // Children button
                const childCondition = encodeURIComponent(`parent=${data.id}`);
                buttons.push(`<button class="misc" data-href="?search=${childCondition}">Children</button>`);

                // Artifacts dropdown
                buttons.push(createArtifactsDropdown(data));

                // Download button
                buttons.push('<button id="downloadbutton" class="download">Download</button>');

                // LAVA job button (if applicable)
                if (data.data?.runtime?.startsWith('lava') && data.data?.job_id) {
                    const lavaUrl = CONFIG.LAVA_URLS[data.data.runtime];
                    if (lavaUrl) {
                        const jobUrl = `https://${lavaUrl}/scheduler/job/${data.data.job_id}`;
                        buttons.push(`<button class="misc" data-href="${jobUrl}">LAVA Job</button>`);
                    }
                }

                // Node size info
                buttons.push(`<span style="margin-left: 10px;">Node size: ${raw.length} bytes</span>`);

                miscButtons.innerHTML = buttons.join('');

                // Attach event listeners
                attachMiscButtonListeners();
            }

            /**
             * Create artifacts dropdown HTML
             * @param {Object} data - Node data object
             * @returns {string} HTML string for artifacts dropdown
             */
            function createArtifactsDropdown(data) {
                const options = [`<option value="${state.apiUrl}/latest/node/${data.id}">Raw node</option>`];

                if (data.artifacts) {
                    Object.entries(data.artifacts).forEach(([name, uri]) => {
                        options.push(`<option value="${uri}">${name}</option>`);
                    });
                }

                return `<select id="artifacts">${options.join('')}</select>`;
            }

            /**
             * Attach event listeners to misc buttons
             */
            function attachMiscButtonListeners() {
                // Misc buttons (navigation)
                const miscLinks = document.getElementsByClassName('misc');
                Array.from(miscLinks).forEach(link => {
                    link.addEventListener('click', handleMiscClick);
                });

                // Download button
                const downloadButtons = document.getElementsByClassName('download');
                Array.from(downloadButtons).forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        const url = document.getElementById('artifacts').value;
                        window.open(url, '_blank');
                    });
                });
            }

            // ================================================================
            // SEARCH FUNCTIONALITY
            // ================================================================

            /**
             * Process and execute a search query
             * @param {Array<string>} conditions - Array of search conditions
             */
            async function processSearch(conditions) {
                try {
                    // Build search URL
                    const conditionParams = conditions
                        .map(cond => convertCondition(decodeURIComponent(cond)))
                        .join('&');

                    const url = `${state.apiUrl}/latest/nodes?${conditionParams}&limit=${CONFIG.SEARCH_LIMIT}`;

                    console.log('Search URL:', url);

                    // Show loading modal
                    showModal('Loading search results...');

                    // Fetch search results
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    hideModal();
                    displaySearchResults(data);

                } catch (error) {
                    hideModal();
                    handleError('Search failed', error);
                }
            }

            /**
             * Convert user-friendly search condition to API format
             * @param {string} condition - Search condition (e.g., "created>2024-01-01")
             * @returns {string} Converted condition for API
             */
            function convertCondition(condition) {
                // Pattern: key operator value (e.g., "created>=2024-01-01")
                const pattern = /^([.a-zA-Z0-9_-]+)([<>!=]+)(.*)/;
                const match = pattern.exec(condition);

                if (!match) {
                    console.warn('Condition does not match pattern:', condition);
                    return condition;
                }

                const [, key, operator, value] = match;
                const apiOperator = CONFIG.OPERATORS[operator] || operator;

                console.log(`Converted: ${key}${operator}${value} -> ${key}${apiOperator}${value}`);
                return `${key}${apiOperator}${value}`;
            }

            /**
             * Display search results in a table
             * @param {Object} data - Search results data
             */
            function displaySearchResults(data) {
                clearDivs();

                const searchDiv = document.getElementById('nodesearchdiv');
                searchDiv.style.display = 'block';

                // Determine table columns based on data
                const columns = [...CONFIG.TABLE_COLUMNS];
                if (data.items.length > 0 && data.items[0].data?.kernel_revision) {
                    columns.push('tree', 'branch', 'commit');
                }

                // Sort results by creation date (newest first)
                data.items.sort((a, b) => new Date(b.created) - new Date(a.created));

                // Build table HTML
                const tableHtml = `
                    <table class="nodesearch">
                        ${createTableHeader(columns)}
                        ${createTableRows(data.items)}
                    </table>
                `;

                searchDiv.innerHTML = tableHtml;
            }

            /**
             * Create table header HTML
             * @param {Array<string>} columns - Column names
             * @returns {string} Table header HTML
             */
            function createTableHeader(columns) {
                const headers = columns.map(col => `<th>${col}</th>`).join('');
                return `<tr>${headers}</tr>`;
            }

            /**
             * Create table rows HTML
             * @param {Array<Object>} items - Node items
             * @returns {string} Table rows HTML
             */
            function createTableRows(items) {
                return items.map(node => {
                    const rowClass = getRowClass(node);
                    const cells = createTableCells(node);
                    return `<tr class="${rowClass}">${cells}</tr>`;
                }).join('');
            }

            /**
             * Get CSS class for table row based on node result
             * @param {Object} node - Node object
             * @returns {string} CSS class name
             */
            function getRowClass(node) {
                const classes = [];

                if (node.result === 'fail') {
                    classes.push('fail');
                } else if (node.result === null && node.state !== 'running') {
                    classes.push('null');
                }

                if (node.jobfilter) {
                    classes.push('jobfilter');
                }

                return classes.join(' ');
            }

            /**
             * Create table cells HTML for a node
             * @param {Object} node - Node object
             * @returns {string} Table cells HTML
             */
            function createTableCells(node) {
                const cells = [];

                // ID cell with links
                cells.push(`
                    <td>
                        <a href="?node_id=${node.id}">${node.id}</a>&nbsp;
                        <a href="?search=parent%3D${node.id}">(Child nodes)</a>
                    </td>
                `);

                // Kind
                cells.push(`<td>${node.kind}</td>`);

                // Name and Platform
                cells.push(`<td>${node.name}</td>`);
                cells.push(`<td>${node.kind === 'job' && node.data?.platform ? node.data.platform : 'N/A'}</td>`);

                // State
                cells.push(`<td>${node.state}</td>`);

                // Result
                cells.push(`<td>${node.result || 'null'}</td>`);

                // Created (with age calculation)
                cells.push(createCreatedCell(node));

                // Kernel revision info (if available)
                if (node.data?.kernel_revision) {
                    const kr = node.data.kernel_revision;
                    cells.push(`<td>${kr.tree}</td>`);
                    cells.push(`<td>${kr.branch}</td>`);
                    cells.push(`<td>${kr.commit}</td>`);
                }

                return cells.join('');
            }

            /**
             * Create the 'created' timestamp cell with age information
             * @param {Object} node - Node object
             * @returns {string} Cell HTML
             */
            function createCreatedCell(node) {
                const created = new Date(node.created);
                const now = new Date();
                const timezoneShift = now.getTimezoneOffset() * 60 * 1000;

                let ageText;
                if (node.state !== 'done') {
                    // Show time since creation
                    const diff = now - created + timezoneShift;
                    ageText = `(${formatTimeDiff(diff)} ago)`;
                } else {
                    // Show processing duration
                    const updated = new Date(node.updated);
                    const diff = updated - created;
                    ageText = `(${formatTimeDiff(diff)})`;
                }

                return `<td>${node.created}${ageText}</td>`;
            }

            // ================================================================
            // USER INTERACTION HANDLERS
            // ================================================================

            /**
             * Handle menu link clicks
             * @param {Event} event - Click event
             */
            function handleMenuClick(event) {
                event.preventDefault();
                const href = this.getAttribute('href');
                const fullUrl = state.pageBaseUrl + href;
                window.history.pushState('', '', fullUrl);
                parseParameters(fullUrl);
            }

            /**
             * Handle misc button clicks (Parent, Children, LAVA Job)
             * @param {Event} event - Click event
             */
            function handleMiscClick(event) {
                event.preventDefault();
                const href = this.getAttribute('data-href');

                // Open external links in new tab
                if (href.startsWith('http')) {
                    window.open(href, '_blank');
                } else {
                    // Navigate internally
                    const fullUrl = state.pageBaseUrl + href;
                    window.history.pushState('', '', fullUrl);
                    parseParameters(fullUrl);
                }

                console.log('Navigation:', href);
            }

            /**
             * Display node ID request form
             */
            function requestNodeId() {
                const requestInfo = document.getElementById('requestinfo');
                requestInfo.innerHTML = `
                    <input type="text" id="nodeid" value="" placeholder="65b09399b198ea6cb7bbffda">
                    <button id="nodeidbutton">Request</button>
                `;
                requestInfo.style.display = 'block';

                // Attach event listener
                document.getElementById('nodeidbutton').addEventListener('click', (event) => {
                    event.preventDefault();
                    const nodeId = document.getElementById('nodeid').value.trim();

                    if (!nodeId) {
                        showError('Node ID cannot be empty');
                        return;
                    }

                    const fullUrl = `${state.pageBaseUrl}?node_id=${nodeId}`;
                    window.history.pushState('', '', fullUrl);
                    displayNode(nodeId);
                });

                // Clear other sections
                const nodeInfo = document.getElementById('nodeinfo');
                nodeInfo.innerHTML = '';
                nodeInfo.style.display = 'none';
            }

            /**
             * Parse URL parameters and route to appropriate handler
             * @param {string} url - Full URL to parse
             */
            function parseParameters(url) {
                const queryString = url.split('?')[1];

                if (!queryString) {
                    clearDivs();
                    return;
                }

                const parameters = queryString.split('&');

                // Check for node_id parameter
                for (const param of parameters) {
                    const [key, value] = param.split('=');

                    if (key === 'node_id') {
                        if (!value) {
                            requestNodeId();
                        } else {
                            displayNode(value);
                        }
                        return;
                    }

                    if (key === 'search') {
                        // Collect all search conditions
                        const conditions = parameters
                            .filter(p => p.startsWith('search='))
                            .map(p => p.split('=')[1]);

                        processSearch(conditions);
                        return;
                    }
                }

                // Unknown parameter
                console.warn('Unknown parameter in URL:', parameters[0]);
                showError('Unknown parameter in URL');
                clearDivs();
            }

            // ================================================================
            // UTILITY FUNCTIONS
            // ================================================================

            /**
             * Format JSON with indentation
             * @param {string} jsonText - JSON string
             * @returns {string} Formatted JSON
             */
            function formatJson(jsonText) {
                try {
                    const json = JSON.parse(jsonText);
                    return JSON.stringify(json, null, 2);
                } catch (error) {
                    console.error('Failed to parse JSON:', error);
                    return jsonText;
                }
            }

            /**
             * Format time difference into human-readable string
             * @param {number} diff - Time difference in milliseconds
             * @returns {string} Formatted time string (e.g., "2h 30m")
             */
            function formatTimeDiff(diff) {
                const hours = Math.floor(diff / (1000 * 60 * 60)) % 24;
                const minutes = Math.floor(diff / (1000 * 60)) % 60;

                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                }
                return `${minutes}m`;
            }

            /**
             * Handle errors with user feedback and console logging
             * @param {string} message - User-friendly error message
             * @param {Error} error - Error object
             */
            function handleError(message, error) {
                console.error(message, error);
                showError(`${message}: ${error.message}`);
            }

            // ================================================================
            // PUBLIC API
            // ================================================================

            return {
                init,
            };
        })();

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', ViewerApp.init);
    </script>
</head>
<body>
    <!-- Modal Dialog -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p id="modalcontent"></p>
        </div>
    </div>

    <!-- Main Navigation Menu -->
    <div id="menu"></div>

    <!-- Content Sections (Initially Hidden) -->
    <div id="requestinfo" style="display: none;"></div>
    <div id="miscbuttons" style="display: none;"></div>
    <div id="nodeinfo" style="display: none;"></div>
    <div id="nodesearchdiv" style="display: none;"></div>
</body>
</html>
